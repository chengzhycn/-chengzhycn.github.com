---
layout: post
title:  "iptables 源地址转换"
date:   2016-03-24 10:23:00
categories: Linux
excerpt:    Linux Site Reliability Engineering
---

* content
{:toc}

默认情况下，发往一个网段或者主机的包的源地址会设置成发送该包的网口的ip地址。但是如果让发往某个网段或者主机的包指定从一个没有配置ip地址的网口出去时，例如：

    ubuntu@sdnhubvm:~/sdn_config[18:37]$ ifconfig tun1
    tun1    Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  
            UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1500  Metric:1
            RX packets:0 errors:0 dropped:0 overruns:0 frame:0
            TX packets:21 errors:0 dropped:0 overruns:0 carrier:0
            collisions:0 txqueuelen:500 
            RX bytes:0 (0.0 B)  TX bytes:1764 (1.7 KB)
            
    ubuntu@sdnhubvm:~/sdn_config[18:37]$ route -n
    Kernel IP routing table
    Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
    0.0.0.0         192.168.99.1    0.0.0.0         UG    0      0        0 eth0
    11.0.2.0        0.0.0.0         255.255.255.0   U     0      0        0 eth1
    11.0.3.0        0.0.0.0         255.255.255.0   U     0      0        0 br0
    11.0.3.4        0.0.0.0         255.255.255.255 UH    0      0        0 tun1
    11.0.5.2        0.0.0.0         255.255.255.255 UH    0      0        0 tun0
    172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
    192.168.0.0     0.0.0.0         255.255.0.0     U     0      0        0 eth0
        
路由表指定通往主机11.0.3.4的从tun1网口出去。然而tun1并没有配置ip地址，这时源地址会从默认ip地址列表中选取最靠前的ip地址：

    ubuntu@sdnhubvm:~/sdn_config[18:40]$ ip addr list
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default 
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
        valid_lft forever preferred_lft forever
        inet6 ::1/128 scope host 
        valid_lft forever preferred_lft forever
    2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1400 qdisc pfifo_fast state UP group default qlen 1000
        link/ether fa:16:3e:da:9a:ff brd ff:ff:ff:ff:ff:ff
        inet 192.168.4.177/16 brd 192.168.255.255 scope global eth0
        valid_lft forever preferred_lft forever
        inet6 2001:da8:205:2060:c955:da2:efa5:eb/64 scope global temporary dynamic 
        valid_lft 542985sec preferred_lft 23985sec
        inet6 2001:da8:205:2060:f816:3eff:feda:9aff/64 scope global dynamic 
        valid_lft 2591949sec preferred_lft 604749sec
        inet6 fe80::f816:3eff:feda:9aff/64 scope link 
        valid_lft forever preferred_lft forever
    3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1400 qdisc pfifo_fast state UP group default qlen 1000
        link/ether fa:16:3e:93:6c:5a brd ff:ff:ff:ff:ff:ff
        inet 11.0.2.6/24 brd 11.0.2.255 scope global eth1
        valid_lft forever preferred_lft forever
        inet6 fe80::f816:3eff:fe93:6c5a/64 scope link 
        valid_lft forever preferred_lft forever
    4: eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1400 qdisc pfifo_fast master ovs-system state UP group default qlen 1000
        link/ether fa:16:3e:7b:c4:3f brd ff:ff:ff:ff:ff:ff
        inet6 fe80::f816:3eff:fe7b:c43f/64 scope link 
        valid_lft forever preferred_lft forever
    5: eth3: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
        link/ether fa:16:3e:3c:5f:0f brd ff:ff:ff:ff:ff:ff
    6: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default 
        link/ether 02:42:d9:dc:9a:05 brd ff:ff:ff:ff:ff:ff
        inet 172.17.42.1/16 scope global docker0
        valid_lft forever preferred_lft forever
    7: ovs-system: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default 
        link/ether a2:8a:bf:2b:89:7f brd ff:ff:ff:ff:ff:ff
    8: br0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1400 qdisc noqueue state UNKNOWN group default 
        link/ether 96:da:3f:37:6b:43 brd ff:ff:ff:ff:ff:ff
        inet 11.0.3.6/24 brd 11.0.3.255 scope global br0
        valid_lft forever preferred_lft forever
        inet6 fe80::94da:3fff:fe37:6b43/64 scope link 
        valid_lft forever preferred_lft forever
    9: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 500
        link/none 
    15: tun1: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 500
        link/none 

除掉本地回环地址，那么发包默认地址就会是eth0的地址。如果我们期望的源地址不是eth0的地址，那么这时候就需要SNAT进行源地址转换。

    sudo iptables -t nat -I POSTROUTING -o tun1 -s 192.168.4.177 -d 11.0.3.0/24 -j SNAT --to-source 11.0.3.6

-t 表示指定nat表，-I 表示插入POSTROUTING链，-o表示output interface，-s 源地址，-d目的地址/网段，-j执行动作，这里是SNAT。更加详细的iptables 指令可参照man手册。
