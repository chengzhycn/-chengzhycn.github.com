{"categories":[{"title":"DNS","uri":"https://chengzhycn.github.io/categories/dns/"},{"title":"Kubernetes","uri":"https://chengzhycn.github.io/categories/kubernetes/"},{"title":"Network","uri":"https://chengzhycn.github.io/categories/network/"},{"title":"Work","uri":"https://chengzhycn.github.io/categories/work/"}],"posts":[{"content":"containerd 安装containerd https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd\n# (Install containerd) ## Set up the repository ### Install required packages sudo yum install -y yum-utils device-mapper-persistent-data lvm2 ## Add docker repository sudo yum-config-manager \\ --add-repo \\ https://download.docker.com/linux/centos/docker-ce.repo ## Install containerd sudo yum install -y containerd.io ## Configure containerd sudo mkdir -p /etc/containerd sudo containerd config default | sudo tee /etc/containerd/config.toml # Restart containerd sudo systemctl restart containerd  crictl 配置 # /etc/crictl.yaml runtime-endpoint: unix:///var/run/containerd/containerd.sock image-endpoint: unix:///var/run/containerd/containerd.sock timeout: 10 debug: false  修改sandbox镜像 在配置文件中指定：\n# /etc/containerd/config.toml [plugins] [plugins.\u0026quot;io.containerd.grpc.v1.cri\u0026quot;] sandbox_image = \u0026quot;k8s.gcr.io/pause:3.2\u0026quot;  修改registry地址 在配置文件中指定：\n# /etc/containerd/config.toml [plugins] [plugins.\u0026quot;io.containerd.grpc.v1.cri\u0026quot;] [plugins.\u0026quot;io.containerd.grpc.v1.cri\u0026quot;.registry] [plugins.\u0026quot;io.containerd.grpc.v1.cri\u0026quot;.registry.mirrors] [plugins.\u0026quot;io.containerd.grpc.v1.cri\u0026quot;.registry.mirrors.\u0026quot;docker.io\u0026quot;] endpoint = [\u0026quot;https://registry-1.docker.io\u0026quot;]  containerd的配置文件格式有多种版本，注意配置文件格式的兼容性。\ncontainerd 配置代理 containerd 配置镜像拉取代理可以在systemd脚本中配置环境变量，直接HTTP_PROXY是没有办法生效的:\n[Unit] Description=containerd container runtime Documentation=https://containerd.io After=network.target [Service] Environment=\u0026quot;HTTP_PROXY=http://10.0.0.1:8888\u0026quot; Environment=\u0026quot;HTTPS_PROXY=http://10.0.0.1:8888\u0026quot; Environment=\u0026quot;NO_PROXY=10.*.*.*,172.*.*.*,*.local,localhost,127.0.0.1\u0026quot; ExecStartPre=/sbin/modprobe overlay ExecStart=/bin/containerd Restart=always RestartSec=5 Delegate=yes KillMode=process OOMScoreAdjust=-999 LimitNOFILE=1048576 LimitNPROC=infinity LimitCORE=infinity [Install] WantedBy=multi-user.target  安装kubeadm、kubectl、kubelet https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/\ncat \u0026lt;\u0026lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo [kubernetes] name=Kubernetes baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\\$basearch enabled=1 gpgcheck=1 repo_gpgcheck=1 gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg exclude=kubelet kubeadm kubectl EOF # Set SELinux in permissive mode (effectively disabling it) sudo setenforce 0 sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config # install dependencies sudo yum install socat libnetfilter_cthelper libnetfilter_queue libnetfilter_cttimeout conntrack-tools sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes sudo systemctl enable --now kubelet  部署集群 验证images pull连通性 kubeadm config images pull --cri-socket /run/containerd/containerd.sock --v=5  初始化第一个节点 kubeadm init \\ --cri-socket /var/run/containerd/containerd.sock \\ --control-plane-endpoint test.node \\ --pod-network-cidr 172.16.0.0/16 \\ --service-cidr 192.168.0.0/16 \\ --skip-phases=addon  addon phases 中配置了 kube-proxy 和 coredns，如果不需要，可以用\u0026ndash;skip-phases跳过。\n初始化完后可以使用kubeadm返回的结果来初始化其它节点。\n加入其它控制面节点 使用初始化第一个节点返回的结果来初始化其它的节点：\nkubeadm join test.node:6443 \\ --token q5n6vm.sj9xpkqr6iyxxxxx \\ --discovery-token-ca-cert-hash sha256:ee352fb3db6aeff1bd3cfebba1c4439641e8a8c151ac4f770fc13f4504xxxxx \\ --control-plane  加入worker节点 kubeadm join test.node:6443 \\ --token q5n6vm.sj9xpkqr6iyxxxxx \\ --discovery-token-ca-cert-hash sha256:ee352fb3db6aeff1bd3cfebba1c4439641e8a8c151ac4f770fc13f4504xxxxx  ","id":0,"section":"posts","summary":"containerd 安装containerd https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd # (Install containerd) ## Set up the repository ### Install required packages sudo yum install -y yum-utils device-mapper-persistent-data lvm2 ## Add docker repository sudo yum-config-manager \\ --add-repo \\ https://download.docker.com/linux/centos/docker-ce.repo ## Install containerd sudo yum install -y containerd.io ## Configure containerd sudo mkdir -p /etc/containerd sudo containerd config default | sudo tee /etc/containerd/config.toml # Restart containerd sudo","tags":["kubernetes","ops"],"title":"Kubeadm安装集群","uri":"https://chengzhycn.github.io/2021/01/kubeadm/","year":"2021"},{"content":"CNAME 记录 记录格式 bar.example.com.\tCNAME\tfoo.example.com. foo.example.com.\tA\t192.168.0.1  CNAME 记录的限制  如果一个 domain name 有了一个 CNAME 记录，那么它不能再拥有其它类型的记录 CNAME 记录必须指向另外一个 domain name，而不是一个 IP CNAME 记录最好不要指向另外一个 CNAME 记录 MX 和 NS 记录不能指向一个 CNAME 记录  SRV 记录 type code：33\n记录格式 _service._protocol.name. TTL class SRV priority weight port target. _sip._tcp.example.com. 86400 IN SRV 0 5 5060 sipserver.example.com.   _service: 服务名称 symbolic name protocol: 协议 name: domain name，以 . 结束 priority: 条目优先级, 值越低优先级越高 weight: 同样优先级内不同条目的权重 target: canonical hostname，以 . 结束 如果是一个 MX 记录，那么 target 需要是一个 IP 地址（A 或者 AAAA）而不是 CNAME  SOA 记录 start of authority, 一个权威的起始\n记录格式 @ IN SOA {primary-name-server} {hostmaster-email} ( {serial-number} {time-to-refresh} {time-to-retry} {time-to-expire} {minimum-TTL} )   primary-name-server: 拥有该 zone 原始 zone file 的 nameserver，不包括通过 AXFR 获取数据的 nameserver hostmaster-email: zone 管理员的邮箱。邮箱地址内的 @ 会用 . 替代。如果地址中本身有 . ，用 / 替代 serial-number: zone 的 版本号。只能增不能减。如果减小或者不变可能会导致 slave XFR 更新错误 time-to-refresh: 用于 secondary nameserver 检测 zone 更新的周期，向 primary nameserver 发起请求。单位为秒 time-to-retry: 用于 secondary nameserver 更新 zone 失败后的重试周期。单位为秒 time-to-expire: 如果超过了这个时间 secondary nameserver 无法和 primary nameserver 建立联系，secondary nameserver 会将该 zone 认为是无效的，停止对外提供服务 时间单位还可以是 M(minute)、H(hour)、D(day)、W(week)  Zone file $ORIGIN example.com. $TTL 86400 @\tIN\tSOA\tdns1.example.com.\thostmaster.example.com. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day IN\tNS\tdns1.example.com. IN\tNS\tdns2.example.com. IN\tMX\t10\tmail.example.com. IN\tMX\t20\tmail2.example.com. dns1\tIN\tA\t10.0.1.1 dns2\tIN\tA\t10.0.1.2\tserver1\tIN\tA\t10.0.1.5 server2\tIN\tA\t10.0.1.6 ftp\tIN\tA\t10.0.1.3 IN\tA\t10.0.1.4 mail\tIN\tA\t10.0.1.8 mail2\tIN\tA\t10.0.1.9 www\tIN\tCNAME\tserver1   $ORIGIN example.com. 表示此 zone file 中的所有域名都是由 host label + $ORIGIN 组成。但是如果 host label 以 . 结束（即认为该 host label 是一个 FQDN），那么将不会扩展 $ORIGIN 一个 zone 文件中是可以存在多个 $ORIGIN 的，$ORIGIN 生效的区间是当前 $ORIGIN 到下一个 $ORIGIN 之间 $TTL 表示 zone 的默认 TTL @ 所在的地方都会由 $ORIGIN 替代 $ORIGIN 后面紧跟着的是 SOA 记录，记录格式见 SOA 记录 上面的 RR 都是用的默认 $TTL，如果需要使用特殊化的 TTL，可以写在每一条 RR 的 hostname 后面  RR 格式 RR 中 无需添加 $ORIGIN\nA \u0026lt;host\u0026gt;\tIN\tA\t\u0026lt;IP-address\u0026gt; IN\tA\t\u0026lt;IP-address-2\u0026gt; ; 多条记录时省略 \u0026lt;host\u0026gt; 字段  CNAME \u0026lt;alias-name\u0026gt;\tIN\tCNAME\t\u0026lt;real-name\u0026gt;  MX \tIN\tMX\t\u0026lt;preference-value\u0026gt;\t\u0026lt;email-server-name\u0026gt; IN MX 10 mail.example.com. IN MX 20 mail2.example.com.   MX 记录用于邮件服务器的解析，如给 abc@example.com 发送邮件，就会先发送一个 关于 example.com. 的MX 记录查询。原则上 MX 记录不能指向 CNAME 记录 preference-value 用作优先级，值越小优先级越高 可以是 hostname，也可以是 FQDN  NS \tIN NS \u0026lt;nameserver-name\u0026gt; IN NS dns1.example.com. IN NS dns2.example.com.   该 zone 的权威解析服务器，只要是权威的都可以记录在这里，不需要管是 master 还是 slave 需要是一个 FQDN  反向解析 zone $ORIGIN 1.0.10.in-addr.arpa. $TTL 86400 @\tIN\tSOA\tdns1.example.com.\thostmaster.example.com. ( 2001062501 ; serial 21600 ; refresh after 6 hours 3600 ; retry after 1 hour 604800 ; expire after 1 week 86400 ) ; minimum TTL of 1 day 1\tIN\tPTR\tdns1.example.com. 2\tIN\tPTR\tdns2.example.com. 5\tIN\tPTR server1.example.com. 6\tIN\tPTR server2.example.com. 3\tIN\tPTR ftp.example.com. 4\tIN\tPTR ftp.example.com.  格式和 forward zone 基本一致，只是 PTR 记录的 target 必须是 FQDN。\n\u0026lt;last-IP-digit\u0026gt;\tIN\tPTR\t\u0026lt;FQDN-of-system\u0026gt;  PTR 记录的完整格式是 \u0026lt;last-IP-digit\u0026gt; + $ORIGIN，因此，PTR 的第一个字段也是可以表示成 FQDN 的\nReference  dns_zone_file  ","id":1,"section":"posts","summary":"CNAME 记录 记录格式 bar.example.com. CNAME foo.example.com. foo.example.com. A 192.168.0.1 CNAME 记录的限制 如果一个 domain name 有了一个 CNAME 记录，那么它不能再拥有其它类型的记录 CNAME 记录必须指向另外一个 domain name，而不是一个","tags":["zone","dns"],"title":"Dns Zone Files","uri":"https://chengzhycn.github.io/2021/01/dns-zone-files/","year":"2021"}],"tags":[{"title":"dns","uri":"https://chengzhycn.github.io/tags/dns/"},{"title":"kubernetes","uri":"https://chengzhycn.github.io/tags/kubernetes/"},{"title":"ops","uri":"https://chengzhycn.github.io/tags/ops/"},{"title":"zone","uri":"https://chengzhycn.github.io/tags/zone/"}]}